// components/MarketingReport.js

import React, { useState, useRef, useEffect } from 'react';
import Image from 'next/image';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import MarketingRadarChart from './MarketingRadarChart';
import TradeoffChart from './TradeoffChart';
import ScoreBarChart from './ScoreBarChart';
import MarketingChordDiagram from './MarketingChordDiagram';
import BenchmarkBarChart from './BenchmarkBarChart';

// --- Centralized Theme ---
const theme = {
    colors: {
        primary: '#1D2951', // Deeper Navy
        accent: '#4A90E2',  // Brighter Blue
        accent2: '#F5A623', // Gold/Orange
        success: '#50E3C2', // Teal
        danger: '#D0021B',   // Red
        text: '#333333',
        lightText: '#555555',
        background: '#FFFFFF',
        lightBackground: '#F8F9FA',
        borderColor: '#DEE2E6',
    },
    fonts: { heading: "'Helvetica Neue', 'Arial', sans-serif", body: "'Helvetica Neue', Arial, sans-serif" },
};

// --- Helper Components ---
const Page = ({ children, className = '' }) => (
    <div className={`report-page ${className}`} style={{
        pageBreakAfter: 'always',
        padding: '20mm 15mm 20mm 15mm', // A4 padding
        backgroundColor: theme.colors.background,
        minHeight: '297mm',
        boxSizing: 'border-box',
        display: 'flex',
        flexDirection: 'column',
    }}>
        {children}
    </div>
);

const SectionTitle = ({ children }) => (
    <h2 style={{ fontFamily: theme.fonts.heading, fontSize: '2.2em', color: theme.colors.primary, borderBottom: `3px solid ${theme.colors.accent}`, paddingBottom: '10px', marginBottom: '25px' }}>{children}</h2>
);

const SectionIntro = ({ children }) => (
    <p style={{ fontFamily: theme.fonts.body, fontSize: '1.1em', color: theme.colors.lightText, lineHeight: '1.6', backgroundColor: theme.colors.lightBackground, padding: '20px', borderLeft: `4px solid ${theme.colors.accent}` }}>
        {children}
    </p>
);

// --- NEW Helper for MCQ Cluster Analysis ---
const McqClusterAnalysis = ({ title, analysis, score, benchmarkScore }) => (
    <div>
        <ScoreBarChart score={score} benchmarkScore={benchmarkScore} />
        <div style={{ borderTop: `1px solid ${theme.colors.borderColor}`, paddingTop: '20px' }}>
            <h4 style={{fontFamily: theme.fonts.heading, color: theme.colors.primary}}>Diagnostic Analysis</h4>
            <p style={{lineHeight: 1.7}}>{analysis.overallInference}</p>
            {/* You can add strengths/improvements back here if desired */}
        </div>
    </div>
);

// In components/MarketingReport.js, use this complete object

const tradeoffLabels = {
    strategicJudgment: { 
        left: 'Performance Focus', 
        right: 'Brand Focus', 
        labels: { 
            1: 'Brand vs Perf.', 3: 'Penetration vs. Loyalty', 5: 'Distinct vs. Differentiate', 7: 'Standard vs. Local', 9: 'Innovation vs. Consistency'
        } 
    },
    brandCommAcumen: { 
        left: 'Strategic Control', 
        right: 'Creative Authenticity', 
        labels: { 
            11: 'Control vs. Authenticity', 13: 'Consistency vs. Customization', 15: 'Emotional vs. Rational', 17: 'Mass vs. Niche'
        } 
    },
    commercialAcumen: { 
        left: 'Profit Optimization', 
        right: 'Market Accessibility', 
        labels: { 
            19: 'Value vs. Affordability', 21: 'Premium vs. Mass-market', 23: 'Dynamic vs. Trust', 25: 'Promotion vs. Equity', 27: 'Cost vs. Investment'
        } 
    },
    leadershipTeamOrientation: { 
        left: 'Structure & Discipline', 
        right: 'Flexibility & Agility', 
        labels: { 
            29: 'Specialists vs. Generalists', 31: 'In-house vs. Outsource', 33: 'Speed vs. Craft', 35: 'Centralized vs. Decentralized', 37: 'Discipline vs. Freedom', 39: 'Retention vs. Renewal', 41: 'KPIs vs. Development', 43: 'Collaboration vs. Accountability', 45: 'Structure vs. Agility', 47: 'Recognition vs. Resilience'
        } 
    },
    resourceAllocationDiscipline: { 
        left: 'Efficiency & Proven Channels', 
        right: 'Effectiveness & Experimentation', 
        labels: { 
            49: 'Brand vs. Performance', 51: 'Acquisition vs. Retention', 53: 'Digital vs. Traditional', 55: 'Global vs. Local', 57: 'Proven vs. Experiment', 59: 'Paid vs. Owned/Earned', 61: 'Always-on vs. Burst', 63: 'Cost Cut vs. Brand Defense', 65: 'Incremental vs. Zero-Based', 67: 'Efficiency vs. Effectiveness'
        } 
    },
    commercialGrowthOrientation: { 
        left: 'Short-term Revenue', 
        right: 'Long-term Value', 
        labels: { 
            69: 'Activation vs. Brand Building', 71: 'Targets vs. CX', 73: 'Sales Enable vs. Market Dev', 75: 'Quarterly vs. Market Share', 77: 'Sales vs. Innovation', 79: 'Conversion vs. Trust'
        } 
    }
};

// --- Main Report Component ---
const MarketingReport = ({ report }) => {
    const [isDownloading, setIsDownloading] = useState(false);
    const [logoBase64, setLogoBase64] = useState(null);
    const reportContentRef = useRef(null);

    useEffect(() => {
        // Fetches the logo and converts it to Base64 for embedding in the PDF
        const fetchLogo = async () => {
            try {
                const response = await fetch('/logo.png');
                const blob = await response.blob();
                const reader = new FileReader();
                reader.onload = () => setLogoBase64(reader.result);
                reader.readAsDataURL(blob);
            } catch (error) {
                console.error("Error loading logo for PDF.", error);
            }
        };
        fetchLogo();
    }, []);

    const handleDownloadPDF = async () => {
        const input = reportContentRef.current;
        if (!input || !logoBase64) {
            alert("Report content is not ready. Please wait a moment.");
            return;
        }

        setIsDownloading(true);
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const reportPages = input.querySelectorAll('.report-page');

        for (let i = 0; i < reportPages.length; i++) {
            if (i > 0) pdf.addPage();
            
            const canvas = await html2canvas(reportPages[i], { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');

            // --- NEW: Custom Footer from PDF instructions ---
            const footerText = "The Marketing Influence Quotient™  •  Accelerating Success  •  www.leadershipaccel.com";
            pdf.setFontSize(8);
            pdf.setTextColor(theme.colors.lightText);
            pdf.text(footerText, pdfWidth / 2, pdfHeight - 10, { align: 'center' });
        }

        pdf.save("Marketing-Influence-Quotient-Report.pdf");
        setIsDownloading(false);
    };

    if (!report) {
        return <Page><h2>Generating Your Report...</h2></Page>;
    }

    const { userInfo, scoredResults, executiveSummary, detailedAnalysis } = report;

    // --- ADD THIS NEW BLOCK TO PREPARE THE CHART DATA ---
    const chartData = scoredResults?.dimensionScores ? 
        Object.keys(scoredResults.dimensionScores).map(key => {
            let label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            // Split long labels into an array of strings for multi-line display
            if (label.length > 25) {
                const words = label.split(' ');
                const midpoint = Math.ceil(words.length / 2);
                label = [words.slice(0, midpoint).join(' '), words.slice(midpoint).join(' ')];
            }
            return {
                dimension: label,
                score: parseFloat(scoredResults.dimensionScores[key].toFixed(1))
            };
        }) 
        : [];
    // --------------------------------------------------------

    // VVVV PASTE THE NEW CONSTANT FOR THE CHORD DIAGRAM HERE VVVV
    const chordData = {
        matrix: scoredResults?.chordMatrix,
        labels: ['Strategic Acumen', 'Commercial Rigor', 'Brand Craft', 'Execution & Leadership'],
        colors: ['#1D2951', '#4A90E2', '#50E3C2', '#F5A623', '#D0021B'] // Using our premium theme colors
    };
    // ^^^^ END OF THE NEW BLOCK ^^^^

    // In components/MarketingReport.js, add this before the return statement

const sectionDescriptions = {
    strategicJudgment: "Strategic Judgment measures a marketer's ability to navigate foundational tensions that define modern marketing strategy. It reflects how consistently they balance competing imperatives, prioritize long-term vs. short-term outcomes, and adapt to business stage, category maturity, and competitive intensity.",
    brandCommAcumen: "Brand & Communication Acumen measures a marketer's ability to balance creative freedom with strategic control, narrative inspiration with rational proof, and broad awareness with precise targeting across today's fragmented media ecosystem.",
    commercialAcumen: "Commercial Acumen measures a marketer's ability to balance financial rigor with brand stewardship when making pricing and budget allocation decisions, signaling cross-functional credibility and readiness for P&L ownership.",
    leadershipTeamOrientation: "Leadership & Team Orientation measures a marketer’s ability to lead, structure, and motivate teams. It reveals whether the professional can balance specialization with flexibility, speed with craft, and short-term delivery with long-term development.",
    resourceAllocationDiscipline: "Resource Allocation Discipline measures a marketer’s ability to make balanced, defensible, and context-sensitive budget decisions, treating marketing as a strategic investment to be deployed rather than a cost to be minimized.",
    commercialGrowthOrientation: "Commercial Growth Orientation measures a marketer’s ability to balance immediate sales pressure with broader drivers of sustainable growth, distinguishing transactional thinking from strategic stewardship.",
    foundationsOfStrategy: "This section explores your command of the core strategic frameworks that shape modern marketing leadership, from consumer behaviour and STP to competitive moats and unit economics.",
    brandAndCommunicationsKnowledge: "This section examines your understanding of the ideas and models that underpin effective brand-building, from storytelling and cultural branding to advertising effectiveness and crisis communication.",
    pricingAndChannelsKnowledge: "This section examines your understanding of pricing models and distribution dynamics—two of the most decisive levers in marketing that link marketing choices directly to commercial outcomes.",
    paucityOfBudgetsKnowledge: "This section assesses your ability to make effective strategic decisions under conditions of budget scarcity, a critical skill in retail marketing and channel selection.",
    digitalAndDataKnowledge: "This section evaluates your ability to navigate the data-driven side of marketing, balancing short-term performance with strategic brand impact and interpreting data with rigor.",
    globalAndCulturalKnowledge: "This section evaluates your understanding of how culture, geography, and market maturity shape marketing strategy in an interconnected world.",
    futureAndThoughtLeadership: "This section evaluates your awareness of the shifts shaping the future of marketing, with a specific focus on the rise of influencer and creator-driven ecosystems.",
    strategyAndPositioningApplication: "This section assesses how well you translate strategic marketing frameworks into applied choices that create competitive advantage in crowded and dynamic markets.",
    brandAndCommunicationApplication: "This section evaluates your ability to apply communication frameworks in real-world, high-stakes contexts where brand credibility can be won or lost.",
    customerAndGrowthApplication: "This section evaluates your ability to design strategies that sustain customer relationships and drive long-term growth through retention and brand-aligned loyalty.",
    channelsAndDistributionApplication: "This section evaluates your ability to navigate the complex power dynamics between brands, retailers, platforms, and consumers to build brand salience.",
    pricingAndMonetizationApplication: "This section evaluates your ability to design and defend pricing strategies that balance profitability, brand positioning, and customer trust.",
    marketingBudgetsApplication: "This section evaluates your ability to make disciplined, persuasive, and forward-looking decisions about marketing budgets, especially under pressure.",
    executionAndPrioritizationDiscipline: "This section evaluates your ability to prioritize effectively and execute with discipline—two capabilities that determine whether strong ideas translate into measurable business outcomes.",
    selfAwarenessAndReflection: "This section evaluates your ability to reflect honestly on setbacks, learn from experience, and demonstrate humility—key predictors of long-term leadership growth.",
    creativityAndNarrativePower: "This section evaluates your ability to demonstrate creativity and harness the power of narrative to create the emotional resonance that drives brand distinctiveness.",
    analyticsKnowledge: "This section evaluates your mastery of the financial and analytical foundations that underpin marketing's credibility at the leadership table."
};

const coreCapabilityChartData = scoredResults?.coreCapabilityScores ? 
        Object.keys(scoredResults.coreCapabilityScores).map(key => ({
            name: key,
            ...scoredResults.coreCapabilityScores[key]
        })) 
        : [];


// In components/MarketingReport.js, replace the entire return statement

    return (
        <div style={{ fontFamily: theme.fonts.body, color: theme.colors.text, maxWidth: '900px', margin: '0 auto', backgroundColor: '#e9ecef' }}>
            <div style={{ textAlign: 'center', padding: '20px', backgroundColor: 'white', borderBottom: '1px solid #dee2e6' }}>
                <p>Your personalized report is ready.</p>
                <button
                    onClick={handleDownloadPDF}
                    disabled={isDownloading || !logoBase64}
                    style={{ padding: '12px 25px', fontSize: '1.1em', cursor: 'pointer', backgroundColor: theme.colors.accent, color: 'white', border: 'none', borderRadius: '5px' }}
                >
                    {isDownloading ? 'Generating PDF...' : 'Download Report as PDF'}
                </button>
            </div>

            <div ref={reportContentRef}>
                {/* Page 1: Cover Page */}
                <Page className="cover-page">
                    <div style={{ flexGrow: 1, display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', textAlign: 'center' }}>
                        <Image src="/logo.png" alt="Leadership Accelerator Logo" width={240} height={96} />
                        <h1 style={{ fontFamily: theme.fonts.heading, fontSize: '3em', color: theme.colors.primary, marginTop: '40px', marginBottom: '10px' }}>The Marketing Influence Quotient™</h1>
                        <p style={{ fontSize: '1.5em', color: theme.colors.accent }}>Accelerating Success</p>
                        <p style={{ fontSize: '1.2em', color: theme.colors.text, marginTop: '80px' }}>Personalized Report For:</p>
                        <p style={{ fontSize: '1.8em', fontFamily: theme.fonts.heading, color: theme.colors.primary }}>{report.userInfo?.name || 'Valued Professional'}</p>
                    </div>
                </Page>
                
                {/* Page 2: About The Leadership Accelerator */}
                <Page>
                    <SectionTitle>The Leadership Accelerator</SectionTitle>
                    <p style={{ lineHeight: 1.7, fontSize: '1.1em' }}>Leadership Accelerator is a global platform committed to redefining professional excellence in the age of disruption. We empower leaders and innovators to sharpen their judgment, expand their influence, and accelerate their growth through cutting-edge learning experiences rooted in research and real-world application.</p>
                    <p style={{ lineHeight: 1.7, fontSize: '1.1em' }}>Our mission is not just to train professionals but to transform them into decision-makers who thrive in complexity, lead with clarity, and shape markets with confidence. By combining rigorous assessments, advanced learning design, and actionable insights, we are building the next generation of leaders who will change the way the world does business.</p>
                    <p style={{ lineHeight: 1.7, fontSize: '1.1em' }}>At The Leadership Accelerator, everything begins with assessments. We believe that transformation starts with clarity - knowing where you stand, what your strengths are, and where blind spots hold you back. Our world-class diagnostic tools, like The Marketing Influence Quotient™, go beyond surface knowledge to reveal how you think, decide, and lead. These insights form the foundation of every journey we design.</p>
                </Page>

                {/* Page 3: About The Marketing Influence Quotient™ */}
                <Page>
                    <SectionTitle>The Marketing Influence Quotient™</SectionTitle>
                    <p style={{ lineHeight: 1.7, fontSize: '1.1em' }}>The Marketing Influence Quotient™ (MIQ™) is the world's most advanced diagnostic assessment for marketing professionals, designed to measure not just what you know, but how you think, decide, and lead. Unlike traditional tests that reward memorization, MIQ™ evaluates your ability to balance trade-offs, navigate ambiguity, and make decisions under real-world pressures.</p>
                    <p style={{ lineHeight: 1.7, fontSize: '1.1em' }}>Every question is engineered to reveal strengths, uncover blind spots, and map learning pathways that sharpen both strategic acumen and executional discipline. Respected by executives and admired across industries, MIQ™ is a benchmark of credibility and influence. It signals to employers, boards, and peers that you possess the rare combination of knowledge, judgment, and adaptability that defines modern marketing leaders.</p>
                    <p style={{ lineHeight: 1.7, fontSize: '1.1em' }}>More importantly, it turns results into opportunities: every outcome is linked to curated learning paths, ensuring that growth doesn't stop at diagnosis but accelerates into transformation. For ambitious professionals, MIQ™ is more than an assessment - it is a career catalyst. It deepens self-awareness, unlocks targeted development, and positions you to lead in a marketplace where clarity, creativity, and influence are the true currencies of success.</p>
                </Page>

                {/* Page 4: Executive Summary */}
                <Page>
                    <SectionTitle>Executive Summary</SectionTitle>
                    {executiveSummary && <>
                        <h3 style={{color: theme.colors.primary}}>Composite Score Analysis</h3>
                        <SectionIntro>{executiveSummary.compositeScoreText}</SectionIntro>
                        <h3 style={{color: theme.colors.primary}}>Top Three Strengths</h3>
                        <SectionIntro>{executiveSummary.strengthsText}</SectionIntro>
                        <h3 style={{color: theme.colors.primary}}>Top Three Development Priorities</h3>
                        <SectionIntro>{executiveSummary.prioritiesText}</SectionIntro>
                        <h3 style={{color: theme.colors.primary}}>Career Impact Statement</h3>
                        <SectionIntro>{executiveSummary.careerImpactStatement}</SectionIntro>
                    </>}
                </Page>

                {/* Page 5: Key Findings at a Glance */}
                <Page>
                    <SectionTitle>Key Findings at a Glance</SectionTitle>
                    <SectionIntro>This section provides a visual summary of your performance across the five core marketing capabilities. For each capability, we compare your score against the industry average and top performers in your peer group.</SectionIntro>
                    {scoredResults && (
                        <div style={{textAlign: 'center', margin: '30px 0'}}>
                            <p style={{fontSize: '1.2em'}}>Your Marketing Index:</p>
                            <p style={{fontSize: '4em', fontWeight: 'bold', color: theme.colors.primary, margin: '10px 0'}}>{scoredResults.percentage.toFixed(1)}%</p>
                        </div>
                    )}
                    <div style={{ width: '100%', height: '400px', marginTop: '40px' }}>
                    <BenchmarkBarChart data={coreCapabilityChartData} />
                    </div>
                </Page>

                {/* --- DETAILED ANALYSIS PAGES --- */}
                {detailedAnalysis && Object.entries(detailedAnalysis).map(([key, value]) => {
                    const isTradeoff = tradeoffLabels[key];
                    const isMcq = typeof value === 'object' && value.overallInference;
                    const description = sectionDescriptions[key] || "";

                    return (
                        <Page key={key}>
                            <SectionTitle>{key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</SectionTitle>
                            
                            <SectionIntro>{description}</SectionIntro>

                            {isTradeoff && (
                                <div style={{ display: 'flex', justifyContent: 'center', marginTop: '30px' }}>
                                    <TradeoffChart 
                                        dataPairs={scoredResults.pairs.filter(p => tradeoffLabels[key].labels[p.qA])}
                                        labels={tradeoffLabels[key]}
                                    />
                                </div>
                            )}
                            
                        {isMcq && (
                            <div style={{ width: '100%', height: '150px', marginTop: '40px' }}>
                                <BenchmarkBarChart 
                                    data={[{
                                        name: 'Score', // A simple label for the single-item view
                                        ...scoredResults.dimensionScores[key]
                                    }]} 
                                    showLegend={false} 
                                />
                            </div>
                        )}
                            
                            {typeof value === 'object' && value.report && (
                                <div style={{ whiteSpace: 'pre-wrap', lineHeight: '1.7', fontSize: '1.1em', marginTop: '30px' }}>{value.report}</div>
                            )}

                             {isMcq && !value.report && (
                                <div style={{ borderTop: `1px solid ${theme.colors.borderColor}`, paddingTop: '20px', marginTop: '30px' }}>
                                    <h4 style={{fontFamily: theme.fonts.heading, color: theme.colors.primary}}>Detailed Analysis</h4>
                                    <p style={{lineHeight: 1.7}}>{value.overallInference}</p>
                                </div>
                            )}
                        </Page>
                    );
                })}
            </div>
        </div>
    );
    
};

export default MarketingReport;